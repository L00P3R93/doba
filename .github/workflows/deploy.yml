name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Setup PHP 8.4 (matches your server)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, json, openssl, pdo, tokenizer, bcmath, gd, mysql, intl, zip, curl

      # Install dependencies
      - name: Install Composer Dependencies
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction

      # Build frontend assets
      - name: Build Assets
        run: |
          npm ci
          npm run build

      # Deploy via SSH
      - name: Deploy to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: ".,!node_modules,!.git,!.github,!tests,!storage/logs/*,!storage/framework/cache/*,!storage/framework/sessions/*,!bootstrap/cache/*.php,!.env,!*.tar.gz,!phpunit.xml,!.phpunit.result.cache"
          target: "/tmp/deploy-new"
          strip_components: 0
          rm: true

      # Execute deployment commands
      - name: Execute Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            DEPLOY_PATH=${{ secrets.DEPLOY_PATH }}
            TEMP_DIR=$(mktemp -d)

            cd $TEMP_DIR
            tar xzf /tmp/deploy.tar.gz 2>/dev/null || rsync -av /tmp/deploy-new/ . 2>/dev/null || echo "Files already in place"

            # Write .env file securely
            chmod 640 .env

            # Install dependencies
            /usr/bin/php8.4 /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction --no-scripts

            # Run package discover separately
            /usr/bin/php8.4 artisan package:discover --ansi || echo "Package discover completed with warnings"

            # Cache configs
            /usr/bin/php8.4 artisan migrate --force --database=mysql || echo "Migration failed - check database connection"
            /usr/bin/php8.4 artisan optimize

            # Set permissions (without sudo where possible)
            find $TEMP_DIR -type f -exec chmod 644 {} \;
            find $TEMP_DIR -type d -exec chmod 755 {} \;
            chmod -R 775 $TEMP_DIR/storage
            chmod -R 775 $TEMP_DIR/bootstrap/cache
            chmod 640 $TEMP_DIR/.env

            # Use sudo only for necessary operations
            sudo chown -R www-data:www-data $TEMP_DIR || echo "chown failed - may need manual fix"

            # Atomic swap
            sudo mv $DEPLOY_PATH /var/www/dobaplay.com.backup.$(date +%Y%m%d%H%M%S) 2>/dev/null || true
            sudo mv $TEMP_DIR $DEPLOY_PATH

            # Restart services
            sudo systemctl restart php8.4-fpm
            sudo systemctl reload apache2

            # Cleanup
            ls -t /var/www/dobaplay.com.backup.* 2>/dev/null | tail -n +4 | xargs -r rm -rf
            rm -f /tmp/deploy.tar.gz /tmp/deploy-new 2>/dev/null || true

            echo "Deployment completed!"
