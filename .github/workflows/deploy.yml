name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Setup PHP 8.4 (matches your server)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, json, openssl, pdo, tokenizer, bcmath, gd, mysql, intl, zip, curl

      # Install dependencies
      - name: Install Composer Dependencies
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction

      # Build frontend assets
      - name: Build Assets
        run: |
          npm ci
          npm run build

      # Create deployment artifact
      - name: Prepare Deployment Artifact
        run: |
          # Wait a moment for any file writes to complete
          sleep 2

          # Create tar excluding volatile directories
          tar czf deploy.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.github' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='bootstrap/cache/*.php' \
            --exclude='.env' \
            --exclude='*.tar.gz' \
            --exclude='phpunit.xml' \
            --exclude='.phpunit.result.cache' \
            .

      # Deploy via SSH
      - name: Deploy to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "deploy.tar.gz"
          target: "/tmp"
          strip_components: 0

      # Execute deployment commands
      - name: Execute Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            DEPLOY_PATH=${{ secrets.DEPLOY_PATH }}
            TEMP_DIR=$(mktemp -d)

            # Extract to temp directory
            cd $TEMP_DIR
            tar xzf /tmp/deploy.tar.gz

            # Write .env file securely
            echo "${{ secrets.ENV_FILE }}" > .env
            chmod 640 .env

            # Install dependencies using PHP 8.4 explicitly
            /usr/bin/php8.4 /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction

            # Run Laravel commands with PHP 8.4
            /usr/bin/php8.4 artisan config:cache
            /usr/bin/php8.4 artisan route:cache
            /usr/bin/php8.4 artisan view:cache
            /usr/bin/php8.4 artisan migrate --force

            # Set proper permissions
            sudo chown -R www-data:www-data $TEMP_DIR
            sudo find $TEMP_DIR -type f -exec chmod 644 {} \;
            sudo find $TEMP_DIR -type d -exec chmod 755 {} \;
            sudo chmod -R 775 $TEMP_DIR/storage
            sudo chmod -R 775 $TEMP_DIR/bootstrap/cache
            sudo chmod 640 $TEMP_DIR/.env

            # Atomic swap
            sudo mv $DEPLOY_PATH /var/www/dobaplay.com.backup.$(date +%Y%m%d%H%M%S) || true
            sudo mv $TEMP_DIR $DEPLOY_PATH

            # Restart only PHP 8.4 FPM (doesn't affect other sites using 8.2)
            sudo systemctl restart php8.4-fpm
            sudo systemctl reload apache2

            # Cleanup old backups (keep last 3)
            ls -t /var/www/dobaplay.com.backup.* 2>/dev/null | tail -n +4 | xargs -r rm -rf

            # Remove temp files
            rm -f /tmp/deploy.tar.gz

            echo "Deployment completed successfully with PHP 8.4!"
